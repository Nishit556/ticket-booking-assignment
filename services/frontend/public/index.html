<!DOCTYPE html>
<html>
<head>
    <title>Cloud Ticket Booking</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üéüÔ∏è Cloud Ticket System</h1>

    <div class="card">
        <h2>1. User Registration (User Service)</h2>
        <input type="text" id="userName" placeholder="Enter Name">
        <input type="email" id="userEmail" placeholder="Enter Email">
        <button class="btn" onclick="registerUser()">Register User</button>
        <p id="userResult"></p>
    </div>

    <div class="card">
        <h2>2. Available Events (Event Catalog)</h2>
        <button class="btn" onclick="loadEvents()">Refresh Events</button>
        <div id="eventsContainer" style="margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h2>3. Generate Ticket (Lambda Trigger)</h2>
        <p>Upload ID Proof to generate ticket:</p>
        <input type="file" id="idProof">
        <button class="btn" onclick="uploadFile()">Upload & Generate</button>
        <p id="uploadResult"></p>
    </div>

    <script>
        let currentUserId = null; // Store logged in user

        // 1. Register User
        async function registerUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            
            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });
                const data = await res.json();
                if (res.ok) {
                    currentUserId = data.userId;
                    document.getElementById('userResult').innerText = `‚úÖ Registered! ID: ${data.userId}`;
                    loadEvents(); // Auto load events after login
                } else {
                    document.getElementById('userResult').innerText = `‚ùå Error: ${data.error}`;
                }
            } catch (e) { alert('Network error'); }
        }

        // 2. Load Events
        async function loadEvents() {
            try {
                const res = await fetch('/api/events');
                const events = await res.json();
                const container = document.getElementById('eventsContainer');
                container.innerHTML = '';

                events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.style.borderColor = '#007bff';
                    div.innerHTML = `
                        <h3>${event.name}</h3>
                        <p>üìç ${event.venue} | üìÖ ${event.date}</p>
                        <p>Tickets Available: ${event.tickets_available}</p>
                        <button class="btn" onclick="bookTicket(${event.id})">Book Now</button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) { 
                document.getElementById('eventsContainer').innerText = 'Failed to load events. Is backend running?';
            }
        }

        // 3. Book Ticket
        async function bookTicket(eventId) {
            if (!currentUserId) return alert("Please Register User first!");
            
            try {
                const res = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: currentUserId, 
                        event_id: eventId,
                        ticket_count: 1 
                    })
                });
                const data = await res.json();
                alert(res.ok ? `‚úÖ Success: ${data.message}` : `‚ùå Error: ${data.error}`);
            } catch (e) { alert('Booking failed'); }
        }

        // 4. Upload File
        async function uploadFile() {
            const fileInput = document.getElementById('idProof');
            if(fileInput.files.length === 0) return alert("Select a file!");

            const formData = new FormData();
            formData.append('id_proof', fileInput.files[0]);

            try {
                document.getElementById('uploadResult').innerText = "Uploading...";
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('uploadResult').innerText = data.message || "Upload Failed";
            } catch (e) { alert('Upload failed'); }
        }
    </script>
</body>
</html>