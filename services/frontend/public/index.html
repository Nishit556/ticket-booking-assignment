<!DOCTYPE html>
<html>
<head>
    <title>Cloud Ticket Booking</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { background-color: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background-color: #0056b3; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üéüÔ∏è Cloud Ticket System</h1>

    <div class="card">
        <h2>1. User Registration (User Service)</h2>
        <input type="text" id="userName" placeholder="Enter Name">
        <input type="email" id="userEmail" placeholder="Enter Email">
        <button class="btn" onclick="registerUser()">Register User</button>
        <p id="userResult"></p>
    </div>

    <div class="card">
        <h2>2. Available Events (Event Catalog)</h2>
        <button class="btn" onclick="loadEvents()">Refresh Events</button>
        <div id="eventsContainer" style="margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h2>3. Booking History</h2>
        <p>Each booking attempt will show up here with a timestamp.</p>
        <div id="bookingHistory" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h2>4. Generate Ticket (Lambda Trigger)</h2>
        <p>Upload ID Proof to generate ticket:</p>
        <input type="file" id="idProof">
        <button class="btn" onclick="uploadFile()">Upload & Generate</button>
        <button class="btn" style="margin-left:10px;background-color:#28a745" onclick="demoUpload()">Demo Ticket</button>
        <p id="uploadResult"></p>
    </div>

    <div class="card">
        <h2>5. Latest Tickets</h2>
        <button class="btn" onclick="refreshTickets()">Refresh Tickets</button>
        <ul id="ticketsList"></ul>
    </div>

    <div class="card">
        <h2>6. Service Status</h2>
        <button class="btn" onclick="refreshStatus()">Refresh Status</button>
        <div id="statusPanel"></div>
    </div>

    <script>
        let currentUserId = null; // Store logged in user
        let bookingCounter = 0;

        window.addEventListener('load', () => {
            loadEvents();
            refreshTickets();
            refreshStatus();
            setInterval(refreshTickets, 10000);
            setInterval(refreshStatus, 10000);
        });

        // 1. Register User
        async function registerUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            
            try {
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });
                const data = await res.json();
                if (res.ok) {
                    currentUserId = data.userId;
                    document.getElementById('userResult').innerText = `‚úÖ Registered! ID: ${data.userId}`;
                    loadEvents(); // Auto load events after login
                } else {
                    document.getElementById('userResult').innerText = `‚ùå Error: ${data.error}`;
                }
            } catch (e) { alert('Network error'); }
        }

        // 2. Load Events
        async function loadEvents() {
            try {
                const res = await fetch('/api/events');
                const events = await res.json();
                const container = document.getElementById('eventsContainer');
                container.innerHTML = '';

                events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.style.borderColor = '#007bff';
                    div.innerHTML = `
                        <h3>${event.name}</h3>
                        <p>üìç ${event.venue} | üìÖ ${event.date}</p>
                        <p>Tickets Available: ${event.tickets_available}</p>
                        <button class="btn" onclick="bookTicket(${event.id})">Book Now</button>
                    `;
                    container.appendChild(div);
                });
            } catch (e) { 
                document.getElementById('eventsContainer').innerText = 'Failed to load events. Is backend running?';
            }
        }

        // 3. Book Ticket
        async function bookTicket(eventId) {
            if (!currentUserId) return alert("Please Register User first!");
            
            try {
                const res = await fetch('/api/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: currentUserId, 
                        event_id: eventId,
                        ticket_count: 1 
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    addBookingRow({ eventId, message: data.message, error: false });
                } else {
                    addBookingRow({ eventId, message: data.error, error: true });
                }
            } catch (e) {
                addBookingRow({ eventId, message: 'Network error', error: true });
            }
        }

        // 4. Upload File
        async function uploadFile() {
            const fileInput = document.getElementById('idProof');
            if(fileInput.files.length === 0) return alert("Select a file!");

            const formData = new FormData();
            formData.append('id_proof', fileInput.files[0]);

            try {
                document.getElementById('uploadResult').innerText = "Uploading...";
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('uploadResult').innerText = data.message || "Upload Failed";
                refreshTickets();
            } catch (e) { document.getElementById('uploadResult').innerText = 'Upload failed'; }
        }

        async function demoUpload() {
            document.getElementById('uploadResult').innerText = "Triggering demo upload...";
            try {
                const res = await fetch('/api/demo-upload', { method: 'POST' });
                const data = await res.json();
                document.getElementById('uploadResult').innerText = data.message || data.error;
                refreshTickets();
            } catch (e) {
                document.getElementById('uploadResult').innerText = 'Demo upload failed';
            }
        }

        function addBookingRow({ eventId, message, error }) {
            bookingCounter += 1;
            const container = document.getElementById('bookingHistory');
            const row = document.createElement('div');
            row.style.borderBottom = '1px solid #eee';
            row.style.padding = '6px 0';
            row.innerHTML = `
                <strong>#${bookingCounter}</strong> Event ${eventId} -
                <span style="color:${error ? 'red' : 'green'}">${message}</span>
                <small style="color:#555;display:block">${new Date().toLocaleTimeString()}</small>
            `;
            container.prepend(row);
        }

        async function refreshTickets() {
            try {
                const res = await fetch('/api/tickets');
                const tickets = await res.json();
                const list = document.getElementById('ticketsList');
                list.innerHTML = '';
                if (tickets.length === 0) {
                    list.innerHTML = '<li>No tickets generated yet.</li>';
                    return;
                }
                tickets.forEach(t => {
                    const li = document.createElement('li');
                    li.textContent = `${t.key} (${new Date(t.lastModified).toLocaleString()})`;
                    list.appendChild(li);
                });
            } catch (e) {
                document.getElementById('ticketsList').innerHTML = '<li>Unable to load tickets.</li>';
            }
        }

        async function refreshStatus() {
            try {
                const res = await fetch('/api/status');
                const statuses = await res.json();
                const panel = document.getElementById('statusPanel');
                panel.innerHTML = statuses.map(s => `
                    <p>
                        <strong>${s.name.toUpperCase()}:</strong>
                        <span style="color:${s.ok ? 'green' : 'red'}">
                            ${s.ok ? 'Healthy' : s.error}
                        </span>
                    </p>
                `).join('');
            } catch (e) {
                document.getElementById('statusPanel').innerText = 'Unable to load status.';
            }
        }
    </script>
</body>
</html>